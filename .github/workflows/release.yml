name: Release

# Trigger on new version tags
on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACOS_SIGN_P12: ${{ secrets.MACOS_DEVELOPER_CERT }}
          MACOS_SIGN_PASSWORD: ${{ secrets.MACOS_DEVELOPER_CERT_PASSWORD }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}

      - name: Check Windows signing secrets
        id: check-windows-secrets
        run: |
          if [[ -n "${{ secrets.WINDOWS_CODE_SIGNING_TOOL_ES_USERNAME }}" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Windows binaries for signing
        if: steps.check-windows-secrets.outputs.available == 'true'
        run: |
          set -e
          echo "Preparing Windows executables for signing..."

          # Create temporary directory for executables only
          mkdir -p dist/windows-signing

          # Find and copy only .exe files to signing directory
          find dist -name "*.exe" -type f -exec cp {} dist/windows-signing/ \;

          exe_count=$(find dist/windows-signing -name "*.exe" -type f | wc -l)
          echo "Found $exe_count .exe files to sign"

          if [ "$exe_count" -eq 0 ]; then
            echo "Warning: No .exe files found to sign"
            exit 1
          fi

      - name: Sign Windows binaries
        if: steps.check-windows-secrets.outputs.available == 'true'
        uses: sslcom/esigner-codesign@v1.3.2
        with:
          command: batch_sign
          username: ${{ secrets.WINDOWS_CODE_SIGNING_TOOL_ES_USERNAME }}
          password: ${{ secrets.WINDOWS_CODE_SIGNING_TOOL_ES_PASSWORD }}
          credential_id: ${{ secrets.WINDOWS_CODE_SIGNING_TOOL_CREDENTIAL_ID }}
          totp_secret: ${{ secrets.WINDOWS_CODE_SIGNING_TOOL_ES_TOTP_SECRET }}
          dir_path: dist/windows-signing
          malware_block: false
          clean_logs: false
          environment_name: PROD

      - name: Re-package signed Windows binaries
        if: steps.check-windows-secrets.outputs.available == 'true'
        shell: bash
        run: |
          set -e
          echo "Re-packaging Windows archives with signed binaries..."

          # Copy signed executables back to their original build directories
          for signed_exe in dist/windows-signing/*.exe; do
            if [ -f "$signed_exe" ]; then
              echo "Processing signed: $(basename "$signed_exe")"
              # Find all build directories and copy the signed exe back
              for builddir in dist/*_windows_*/; do
                if [ -d "$builddir" ] && [ -f "$builddir/crypto-finder.exe" ]; then
                  cp -f "$signed_exe" "$builddir/crypto-finder.exe"
                  echo "  ✓ Copied to: $builddir"
                fi
              done
            fi
          done

          # Find all Windows .zip files and re-package them
          for zipfile in dist/*_windows_*.zip; do
            if [ -f "$zipfile" ]; then
              echo "Re-packaging: $zipfile"

              # Extract archive name without extension
              basename=$(basename "$zipfile" .zip)

              # Create temporary directory for extraction
              tempdir="dist/temp_${basename}"
              mkdir -p "$tempdir"

              # Extract the original archive
              unzip -q "$zipfile" -d "$tempdir"

              # Use the signed exe from windows-signing directory
              if [ -f "dist/windows-signing/crypto-finder.exe" ]; then
                echo "  Replacing with signed binary"
                cp -f "dist/windows-signing/crypto-finder.exe" "$tempdir/crypto-finder.exe"

                # Re-create the zip archive
                cd "$tempdir"
                zip -q -r "../${basename}.zip" .
                cd - > /dev/null

                echo "  ✓ Re-packaged with signed binary"
              else
                echo "  Warning: Signed binary not found"
              fi

              rm -rf "$tempdir"
            fi
          done

          # Regenerate checksums for all archives
          shopt -s nullglob
          files=(dist/crypto-finder_*_checksums.txt)

          if [ ${#files[@]} -gt 0 ]; then
            echo ""
            echo "Regenerating checksums..."
            cd dist

            # Remove old checksums
            rm -f *_checksums.txt

            # Build archives array in the dist directory
            archives=(*.tar.gz *.zip)

            # Generate new checksums for all archives
            if [ ${#archives[@]} -gt 0 ]; then
              # Extract version from first archive name using parameter expansion
              first_archive="${archives[0]}"
              # Extract version (e.g., v1.2.3) from filename like crypto-finder_v1.2.3_linux_amd64.tar.gz
              version="${first_archive#crypto-finder_}"  # Remove prefix
              version="${version%%_*}"  # Extract first token (the version)
              version="${version:-v0.0.0}"  # Fallback to v0.0.0 if extraction fails

              sha256sum "${archives[@]}" | tee "crypto-finder_${version}_checksums.txt"
            else
              echo "Error: No archives found to checksum"
              exit 1
            fi

            cd - > /dev/null
            echo "✓ Checksums updated"
          fi

          echo ""
          echo "Windows binary re-packaging complete!"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*_checksums.txt
